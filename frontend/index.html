<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoftSkills360 - Acceso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos personalizados para el tema oscuro */
        :root {
            --primary: #10b981; /* Esmeralda 500 */
            --background: #0f172a; /* Slate 900 */
            --card: #1e293b; /* Slate 800 */
            --text: #f8fafc; /* Slate 50 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .form-card {
            background-color: var(--card);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 100%;
        }
        .input-field {
            background-color: #334155; /* Slate 700 */
            border: 1px solid #475569; /* Slate 600 */
            color: var(--text);
            transition: border-color 0.3s;
        }
        .input-field:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
        }
        .btn-primary {
            background-color: var(--primary);
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #059669; /* Esmeralda 600 */
        }
        .btn-primary:active {
            transform: scale(0.99);
        }
        /* Estilo para los mensajes de validaci√≥n */
        .validation-tip {
            font-size: 0.8rem;
            margin-top: 0.25rem;
            color: #f87171; /* Rojo suave */
        }
    </style>
</head>
<body>

    <div class="form-card p-8 rounded-xl">
        <h1 class="text-3xl font-extrabold text-center mb-6">SoftSkills360</h1>

        <form id="loginForm">
            <h2 class="text-xl font-bold mb-6 text-center">Inicia Sesi√≥n</h2>
            <div class="mb-4">
                <label for="loginEmail" class="block text-sm font-medium mb-1">Correo Electr√≥nico</label>
                <input type="email" id="loginEmail" placeholder="tu.correo@ejemplo.com" class="input-field w-full p-3 rounded-lg" required>
            </div>
            <div class="mb-6">
                <label for="loginPassword" class="block text-sm font-medium mb-1">Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="input-field w-full p-3 rounded-lg" required>
            </div>
            <button type="submit" id="loginBtn" class="btn-primary w-full text-white font-semibold py-3 rounded-lg">
                Iniciar Sesi√≥n
            </button>
            <p class="mt-4 text-center text-sm">
                ¬øA√∫n no tienes cuenta? 
                <span id="toRegister" class="text-primary hover:underline cursor-pointer font-medium">Reg√≠strate aqu√≠</span>
            </p>
        </form>

        <form id="registerForm" style="display: none;">
            <h2 class="text-xl font-bold mb-6 text-center">Crea tu Cuenta</h2>
            <div class="mb-4">
                <label for="regName" class="block text-sm font-medium mb-1">Nombre</label>
                <input type="text" id="regName" placeholder="Tu Nombre Completo" class="input-field w-full p-3 rounded-lg" required>
            </div>
            <div class="mb-4">
                <label for="regEmail" class="block text-sm font-medium mb-1">Correo Electr√≥nico</label>
                <input type="email" id="regEmail" placeholder="tu.correo@ejemplo.com" class="input-field w-full p-3 rounded-lg" required>
                <p id="emailValidationTip" class="validation-tip hidden text-red-400">üö® Por favor, introduce un correo v√°lido.</p>
            </div>
            <div class="mb-6">
                <label for="regPassword" class="block text-sm font-medium mb-1">Contrase√±a</label>
                <input type="password" id="regPassword" placeholder="M√≠nimo 8 caracteres, may√∫s, n√∫mero, s√≠mbolo" class="input-field w-full p-3 rounded-lg" required>
                <p id="passwordValidationTip" class="validation-tip hidden text-red-400"></p>
            </div>
            <button type="submit" id="registerBtn" class="btn-primary w-full text-white font-semibold py-3 rounded-lg">
                Registrarse
            </button>
            <p class="mt-4 text-center text-sm">
                ¬øYa tienes cuenta? 
                <span id="toLogin" class="text-primary hover:underline cursor-pointer font-medium">Inicia Sesi√≥n</span>
            </p>
        </form>
    </div>

    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-70 hidden flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-90 transition-transform duration-300">
            <div class="flex items-center mb-4">
                <div id="modalIcon" class="w-8 h-8 rounded-full flex items-center justify-center mr-3"></div>
                <h3 id="modalTitle" class="text-xl font-bold text-gray-900"></h3>
            </div>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <button id="modalCloseBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg w-full hover:bg-gray-300 transition-colors">
                Aceptar
            </button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de la URL de tu API
        const API_URL = "https://encuestaa.onrender.com";¬†

        // --- L√ìGICA DEL MODAL (Reemplazo de alert) ---
        const modal = document.getElementById("messageModal");
        const modalCloseBtn = document.getElementById("modalCloseBtn");
        const modalTitle = document.getElementById("modalTitle");
        const modalMessage = document.getElementById("modalMessage");
        const modalIcon = document.getElementById("modalIcon");
        const modalContent = modal.querySelector('div');

        // Obtener los botones para deshabilitarlos
        const registerBtn = document.getElementById("registerBtn");
        const loginBtn = document.getElementById("loginBtn");

        modalCloseBtn.onclick = () => hideMessage();
        ¬†
        function showMessage(title, message, isSuccess = true) {
            // Configurar el estilo del modal
            const iconHTML = isSuccess¬†
                ? '<i data-lucide="check-circle" class="text-green-600"></i>'¬†
                : '<i data-lucide="x-circle" class="text-red-600"></i>';
            const iconBg = isSuccess ? 'bg-green-100' : 'bg-red-100';

            modalIcon.innerHTML = iconHTML;
            modalIcon.className = `w-8 h-8 rounded-full flex items-center justify-center mr-3 ${iconBg}`;
            modalTitle.textContent = title;
            modalMessage.textContent = message;

            // Mostrar el modal con transici√≥n
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('opacity-100');
                modalContent.classList.remove('scale-90');
            }, 10);
            ¬†
            // Re-renderizar los iconos de lucide
            lucide.createIcons();
        }

        function hideMessage() {
            modal.classList.remove('opacity-100');
            modalContent.classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        ¬†
        // --- L√ìGICA DE VALIDACI√ìN ---

        function isValidEmail(email) {
            // Regex b√°sico para validar el formato de correo
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function getPasswordSuggestion(password) {
            let suggestions = [];
            if (password.length < 8) {
                suggestions.push("Debe tener al menos 8 caracteres.");
            }
            if (!/[A-Z]/.test(password)) {
                suggestions.push("Incluye al menos una letra may√∫scula.");
            }
            if (!/[a-z]/.test(password)) {
                suggestions.push("Incluye al menos una letra min√∫scula.");
            }
            if (!/\d/.test(password)) {
                suggestions.push("Incluye al menos un n√∫mero.");
            }
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                suggestions.push("Incluye al menos un s√≠mbolo (!@#$, etc.).");
            }
            return suggestions;
        }

        function isStrongPassword(password) {
            const suggestions = getPasswordSuggestion(password);
            return suggestions.length === 0;
        }

        // --- MANEJO DE VISTAS ---
        document.getElementById("toRegister").onclick = () => {
            document.getElementById("loginForm").style.display = "none";
            document.getElementById("registerForm").style.display = "block";
        };
        document.getElementById("toLogin").onclick = () => {
            document.getElementById("registerForm").style.display = "none";
            document.getElementById("loginForm").style.display = "block";
        };

        // --- HANDLERS PRINCIPALES DE FORMULARIO ---

        // ---- Registro Handler (CON CORRECCI√ìN DE DOBLE ENV√çO Y MANEJO DE UNICIDAD) ----
        async function handleRegister() {
            const name = document.getElementById("regName").value;
            const email = document.getElementById("regEmail").value.trim();
            const password = document.getElementById("regPassword").value;
            const emailTip = document.getElementById("emailValidationTip");
            const passwordTip = document.getElementById("passwordValidationTip");

            // 1. Validaciones de formato (cliente)
            if (!isValidEmail(email)) {
                emailTip.classList.remove("hidden");
                return;
            } else {
                emailTip.classList.add("hidden");
            }

            if (!isStrongPassword(password)) {
                const suggestions = getPasswordSuggestion(password);
                passwordTip.innerHTML = `‚ö†Ô∏è Contrase√±a d√©bil. Sugerencias:<ul>${suggestions.map(s => `<li>${s}</li>`).join('')}</ul>`;
                passwordTip.classList.remove("hidden");
                return;
            } else {
                passwordTip.classList.add("hidden");
            }

            // --- Deshabilitar el bot√≥n para prevenir doble env√≠o ---
            registerBtn.disabled = true;
            registerBtn.textContent = 'Registrando...';

            // 2. Llamada a la API
            try {
                const res = await fetch(`${API_URL}/api/register`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name, email, password }),
                });

                const data = await res.json();
                if (res.ok) {
                    showMessage("Registro Exitoso", "¬°Tu cuenta ha sido creada! Por favor, inicia sesi√≥n.", true);
                    // Cambiar a la vista de login autom√°ticamente
                    document.getElementById("toLogin").click();
                } else {
                    // --- Manejo de error de duplicidad ---
                    let errorMessage = data.detail || "Error desconocido.";
                    
                    if (typeof errorMessage === 'string') {
                        if (errorMessage.includes("Email already registered")) {
                            errorMessage = "El correo electr√≥nico ya est√° registrado. Intenta iniciar sesi√≥n.";
                        } else if (errorMessage.includes("Username already taken")) {
                            errorMessage = "El nombre de usuario ya est√° en uso. Elige otro.";
                        }
                    }

                    showMessage("Error al Registrar", errorMessage, false);
                }
            } catch (error) {
                showMessage("Error de Conexi√≥n", "No se pudo conectar con la API. Verifica la URL de Render.", false);
            } finally {
                // --- Volver a habilitar el bot√≥n ---
                registerBtn.disabled = false;
                registerBtn.textContent = 'Registrarse';
            }
        }
        ¬†
        // ---- Login Handler (CON CORRECCI√ìN DE DOBLE ENV√çO) ----
        async function handleLogin() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;

            // --- Deshabilitar el bot√≥n para prevenir doble env√≠o ---
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando...';

            try {
                const res = await fetch(`${API_URL}/api/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password }),
                });

                const data = await res.json();

                if (res.ok) {
                    // Guarda el token y el nombre del usuario
                    localStorage.setItem("token", data.token);
                    localStorage.setItem("userName", data.name);
                    showMessage("Inicio Exitoso", `¬°Bienvenido, ${data.name}! Redirigiendo...`, true);
                    
                    // Peque√±o retardo para que el usuario vea el mensaje
                    setTimeout(() => {
                        window.location.href = "home.html";
                    }, 1000);

                } else {
                    showMessage("Error de Acceso", `${data.detail || "Email o contrase√±a incorrectos."}`, false);
                }
            } catch (error) {
                showMessage("Error de Conexi√≥n", "No se pudo conectar con la API. Verifica la URL de Render.", false);
            } finally {
                // --- Volver a habilitar el bot√≥n ---
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        }
        ¬†
        // --- ASIGNACI√ìN DE HANDLERS Y SUBMIT POR ENTER (¬°FINAL!) ---
        ¬†
        // 1. Asignar handlers al evento submit de los formularios (esto maneja el bot√≥n y la tecla Enter)
        document.getElementById("registerForm").addEventListener('submit', function(e) {
            e.preventDefault(); // Detiene el env√≠o de formulario nativo
            handleRegister();
        });
        ¬†
        document.getElementById("loginForm").addEventListener('submit', function(e) {
            e.preventDefault(); // Detiene el env√≠o de formulario nativo
            handleLogin();
        });
        ¬†
        // 2. Los listeners de click originales en los botones ya no son necesarios
        document.getElementById("registerBtn").onclick = () => { /* No hacer nada aqu√≠ */ };
        document.getElementById("loginBtn").onclick = () => { /* No hacer nada aqu√≠ */ };
    </script>
</body>
</html>
